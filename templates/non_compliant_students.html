{% extends "trainer.html" %}
{% block content %}
<link rel="stylesheet" href="static/css/non_compliant_students.css">
<br><br><br><br><br>
<div class="container-noncompliant">
  <div class="page-hero d-flex justify-content-between align-items-center">

    <div>
      <h2>Non-Compliant Students</h2>
      <p class="small mb-0">Manage records of students who are non-compliant ‚Äî update status, edit or remove entries.</p>
    </div>
    <div class="ms-3 w-50">
      <input id="searchInput" class="form-control" type="search" placeholder="Search ...">
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Admission Number</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Reason</th>
          <th>Duration</th>
          <th>Send Date</th>
          <th>Return Date</th>
          <th>Status</th>
          <th>Update Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for student in students %}
        <tr data-admission-no="{{ student[0] }}">
  <td class="admission_no">{{ student[0] }}</td>
  <td class="first_name">{{ student[1] }}</td>
  <td class="last_name">{{ student[2] }}</td>
  <td class="reason">{{ student[3] }}</td>
  <td class="duration">{{ student[4] }}</td>
  <td class="send_date">{{ student[5] }}</td>
  <td class="return_date">{{ student[6] }}</td>
  <td class="status">{{ student[7] }}</td>
  <td>
    <form action="/update-status/{{ student[0] }}" method="POST" class="d-flex update-action align-items-center">
      <select name="status" class="form-select form-select-sm me-2">
        <option value="Reported" {% if student[7] == 'Reported' %}selected{% endif %}>Reported</option>
        <option value="Pending" {% if student[7] == 'Pending' %}selected{% endif %}>Pending</option>
        <option value="Absent" {% if student[7] == 'Absent' %}selected{% endif %}>Absent</option>
      </select>
      <button type="submit" class="btn btn-sm btn-outline-primary update-btn">Update</button>
    </form>
  </td>
  <td>
    <div class="d-flex align-items-center">
      <form action="/delete-student1/{{ student[0] }}" method="POST" style="display:inline;">
        <button type="submit" class="btn btn-sm btn-danger delete-btn">Delete</button>
      </form>
      <button class="btn btn-sm btn-primary edit-btn" onclick="editRow(this)">‚úè Edit</button>
      <button class="btn btn-sm btn-success save-btn d-none" onclick="saveRow(this)">üíæ Save</button>
      <button class="btn btn-sm btn-secondary cancel-btn d-none" onclick="cancelEdit(this)">‚úñ Cancel</button>
    </div>
  </td>
</tr>

        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">Add New Non-Compliant Student</h5>
      <form action="/add-student3" method="POST" class="row g-3">
        <div class="col-md-4">
          <label class="form-label" for="admission_no">Admission Number</label>
          <input class="form-control" type="text" id="admission_no" name="admission_no" required>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="first_name">First Name</label>
          <input class="form-control" type="text" id="first_name" name="first_name" required>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="last_name">Last Name</label>
          <input class="form-control" type="text" id="last_name" name="last_name" required>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="reason">Reason</label>
          <input class="form-control" type="text" id="reason" name="reason" required>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="duration">Duration</label>
          <input class="form-control" type="text" id="duration" name="duration" required>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="send_date">Send Date</label>
          <input class="form-control" type="date" id="send_date" name="send_date" required>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="return_date">Return Date</label>
          <input class="form-control" type="date" id="return_date" name="return_date" required>
        </div>

        <div class="col-12 text-end">
          <button class="btn btn-primary" type="submit">Add Student</button>
        </div>
      </form>
    </div>
  </div>

  <div class="empty-state" id="emptyState" style="display:none;">No records found.</div>
</div>

<script>
// client-side filter for the students table (instant feedback)
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('searchInput');
  const rows = document.querySelectorAll('#tableBody tr');
  const emptyState = document.getElementById('emptyState');
  if (!input) return;
  input.addEventListener('input', function (e) {
    const q = e.target.value.trim().toLowerCase();
    let visible = 0;
    rows.forEach(r => {
      const txt = r.textContent.toLowerCase();
      const show = q === '' || txt.includes(q);
      r.style.display = show ? '' : 'none';
      if (show) visible += 1;
    });
    emptyState.style.display = visible === 0 ? '' : 'none';
  });
});
</script>
<script>
function editRow(button) {
  const row = button.closest('tr');

  // Hide Edit button, show Save and Cancel buttons
  row.querySelector('.edit-btn').classList.add('d-none');
  row.querySelector('.save-btn').classList.remove('d-none');
  row.querySelector('.cancel-btn').classList.remove('d-none');

  // Define columns that are editable, skip actions & update status
  const editableClasses = ['first_name', 'last_name', 'reason', 'duration', 'send_date', 'return_date', 'status'];

  editableClasses.forEach(cls => {
    const td = row.querySelector(`td.${cls}`);
    const value = td.innerText.trim();

    if (cls === 'status') {
      td.innerHTML = `
        <select class="form-select form-select-sm">
          <option value="Reported" ${value === 'Reported' ? 'selected' : ''}>Reported</option>
          <option value="Pending" ${value === 'Pending' ? 'selected' : ''}>Pending</option>
          <option value="Absent" ${value === 'Absent' ? 'selected' : ''}>Absent</option>
        </select>
      `;
    } else if (cls === 'send_date' || cls === 'return_date') {
      td.innerHTML = `<input type="date" class="form-control form-control-sm" value="${value}">`;
    } else if (cls === 'duration') {
      // Use a text input for duration (you can customize as needed)
      td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value}">`;
    } else {
      td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value}">`;
    }
  });
}

function cancelEdit(button) {
  // For simplicity, reload page to cancel editing
  location.reload();
}

function saveRow(button) {
  const row = button.closest('tr');
  const admissionNo = row.dataset.admissionNo;

  const data = {
    admission_no: admissionNo,
    first_name: row.querySelector('td.first_name input').value,
    last_name: row.querySelector('td.last_name input').value,
    reason: row.querySelector('td.reason input').value,
    duration: row.querySelector('td.duration input').value,
    send_date: row.querySelector('td.send_date input').value,
    return_date: row.querySelector('td.return_date input').value,
    status: row.querySelector('td.status select').value
  };

  fetch('/update-student', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(resp => {
    if (resp.success) {
      alert('Student updated successfully!');
      location.reload();
    } else {
      alert('Error: ' + resp.error);
    }
  })
  .catch(err => {
    alert('Network error');
  });
}

</script>


{% endblock %}
